#!/usr/bin/env bash
# Enforce GPG signatures for every commit pushed to a remote.
# Install via: cp scripts/git-hooks/pre-push-verify-signatures .git/hooks/pre-push && chmod +x .git/hooks/pre-push

set -euo pipefail

remote_name=${1:-}
remote_url=${2:-}
zero_sha=$(printf '%040d' 0)

while read -r local_ref local_sha remote_ref remote_sha; do
    [[ -z "${local_ref:-}" ]] && break

    # Skip deletions
    if [[ "$local_sha" == "$zero_sha" ]]; then
        continue
    fi

    if [[ "$remote_sha" == "$zero_sha" ]]; then
        range="$local_sha"
    else
        range="${remote_sha}..${local_sha}"
    fi

    log_output=$(GIT_LOG_SHOW_SIGNATURE=false git log --pretty='%h %G? %s' "$range" -- 2>/dev/null || true)
    commit_lines=$(awk '/^[0-9a-f]/ {print}' <<<"$log_output")
    if [[ -n "$commit_lines" ]]; then
        unsigned=$(awk '$2 != "G" {print}' <<<"$commit_lines")
        if [[ -n "$unsigned" ]]; then
            cat >&2 <<EOF
ðŸš« Push blocked: unsigned or unverifiable commits detected.
Remote: ${remote_name:-unknown} (${remote_url:-unknown})
Range: $range
Problem commits:
$unsigned

All commits must carry a valid GPG signature before pushing.
Run:
  git commit --amend --no-edit --gpg-sign
or
  git rebase --exec 'git commit --amend --no-edit --gpg-sign'
to re-sign offending commits.
EOF
            exit 1
        fi
    fi

    while read -r commit_sha; do
        git verify-commit "$commit_sha" >/dev/null 2>&1 || {
            echo "ðŸš« Push blocked: git verify-commit failed for $commit_sha" >&2
            exit 1
        }
    done < <(git rev-list "$range")
done

exit 0
